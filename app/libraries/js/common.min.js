function validateUser(e){if(e.length<3||e.length>20)$("#user_group").attr("class","form-group has-error"),$("#username").attr("data-original-title","Username must be longer than 2 characters but less than 15"),$("#username").tooltip("show");var t=$.ajax({type:"GET",data:{username:e},url:"//mutualcog.com/profile/validate-username",async:!1}).responseText;t==2&&$("#pass2").val()!=""?($("#user_group").attr("class","form-group has-error"),$("#username").attr("data-original-title","That username already exists"),$("#username").tooltip("show"),module.user_validated=0):t==3?($("#user_group").attr("class","form-group has-error"),$("#username").attr("data-original-title","Your username must contain at least one character"),$("#username").tooltip("show"),module.user_validated=0):($("#pass2").val()!=""&&($("#user_group").attr("class","form-group"),$("#username").tooltip("destroy")),module.user_validated=1)}function validateLogin(e,t){var n=$.ajax({type:"GET",data:{username:e,pass:t},url:"//mutualcog.com/profile/validate-login",async:!1}).responseText;n==1?(module.pass1_validated=1,$("#user_group").attr("class","form-group"),$("#pass1_group").attr("class","form-group"),$("#username").tooltip("destroy")):(module.pass1_validated=0,$("#user_group").attr("class","form-group has-error"),$("#pass1_group").attr("class","form-group has-error"),$("#username").attr("data-original-title","Your username or password is incorrect"),$("#username").tooltip("show"))}function validatePasswords(e,t){e!=t&&t!=""?($("#pass1_group").attr("class","form-group has-error"),$("#pass2_group").attr("class","form-group has-error"),$("#pass2").tooltip("show"),module.pass2_validated=0,module.pass1_validated=0):(e.length<6||e.length>30)&&t!=""?($("#pass1_group").attr("class","form-group has-error"),$("#pass2_group").attr("class","form-group has-error"),$("#pass").tooltip("show"),module.pass2_validated=0,module.pass1_validated=0):($("#pass1_group").attr("class","form-group"),$("#pass2_group").attr("class","form-group"),$("#pass2").tooltip("destroy"),$("#pass").tooltip("destroy"),module.pass2_validated=1,module.pass1_validated=1)}function cookiesEnabled(){var e=navigator.cookieEnabled;if(e===!1)return!1;if(!document.cookie&&(e===null||!1)){document.cookie="testcookie=1";if(!document.cookie)return!1;document.cookie="testcookie=; expires="+(new Date(0)).toUTCString()}return!0}module=function(){var e=1,t=recent=0,n=0;if(typeof io!="undefined")var r=io.connect("http://localhost:3000/",{query:"sid="+$("#sid").attr("data-sid")+"&serial="+$("#serial_tracker").text()});else var r=$("body");var i=$("#serial_id").text(),s=$("#serial_tracker").text(),o=$("#user_id").text(),u=$("#user_tracker").text(),a="",f=0,l=0,c=0;return{user_validated:f,pass1_validated:l,pass2_validated:c,typ_cnt:n,pm_info:a,recent:recent,focused:e,title_blinking:t,socket:r,serial_id:i,serial_tracker:s,user_id:o,user_tracker:u}}();var selected_tag=-1;updateChatTimes=function(){$.each($(".chat_time"),function(e,t){$(this).text(moment.utc($(this).attr("id")).fromNow())}),$(".last_login").length&&$(".last_login").html("<strong>Last login: </strong>"+moment.utc($(".last_login").attr("id")).fromNow())},updateTimes=function(){$.each($(".time"),function(e,t){$(this).text(moment.utc($(this).attr("id")).fromNow())})},pm_scroll_mod=function(){var e=$(this);e.parent().attr("data-stop-scroll","1"),window.setTimeout(function(){e.parent().attr("data-stop-scroll","0")},1e4)},$(window).on("blur",function(){module.focused=0,module.user_id.length&&(module.recent+=110)}),$(window).on("focus",function(){module.focused=1,module.user_id.length&&(module.recent>120&&module.socket.emit("seen_chats"),module.recent=0)}),$(document).ready(function(){module.user_id.length&&(window.setInterval(function(){module.typ_cnt>1?module.typ_cnt--:module.typ_cnt==1&&(module.typ_cnt--,module.socket.emit("not_typing",{pm_id:module.pm_info[2],friend_id:module.pm_info[1],user_id:module.user_id})),module.recent>120?$.ajax({type:"POST",data:{user_id:module.user_id},url:"//mutualcog.com/profile/update-online-status",success:function(){},error:function(){}}):module.recent++},1e3),$(window).on("mousemove",function(){module.recent>120&&module.socket.emit("seen_chats"),module.recent=0})),$(".pm_body").length&&($(".pm_body").mCustomScrollbar({theme:"light-2"}),$(".pm_body").mCustomScrollbar("scrollTo","bottom",{scrollInertia:0}),window.setTimeout(function(){$(".pm_visible").css("visibility","")},50)),updateChatTimes(),updateTimes(),setInterval(updateTimes,6e4),setInterval(updateChatTimes,6e4),$.each($(".pm_message"),function(e,t){$(".pm_message").eq(e).attr("title",moment.utc($(".pm_message").eq(e).attr("title")).local().format("hh:mma"))}),$(".chat_status_indicator").tooltip(),$(".advanced_cog").tooltip(),$("#pause_chat").tooltip(),$(".mssg_upvote").on("click",upvoteMssg),$(".mssg_downvote").on("click",downvoteMssg),$("#mssg_requests").popover({html:!0}),$("#global_requests").popover({html:!0}),$("#friend_requests").popover({html:!0}),$("#user_props").change(function(){module.socket.emit("change_user_props",{props:$(this).val()})}),$("body").on("click",".pm_remove",function(){$(this).parent().parent().remove();var e=$(this).parent().parent().attr("id").split("_");return module.socket.emit("leave_pm",{pm_id:e[2],friend_id:e[1]}),!1}),$("body").on("click",".friend_box",function(){var e=$(this).attr("id").replace("friend_box_for_",""),t=$(this).attr("data-friend-id"),n=$(this).attr("data-pm-chat-id"),r=$(this).find("#friend_"+t+"_status").attr("class").replace("friend_status","");$("#pm_"+t+"_"+n).length==0&&(module.socket.emit("join_pm",{friend_id:t,friend_name:e,pm_id:n},function(e){$("#pm_"+e.friend_name).attr("id","pm_"+e.friend_id+"_"+e.pm_id)}),$.ajax({type:"GET",data:{pm_id:n},url:"//mutualcog.com/chat/pm-log",success:function(i){var s='<div class="pm_cont" id="pm_'+t+"_"+n+'" data-stop-scroll="0">';s+='<div class="pm_header"><div class="'+r+' pm_status"></div><div class="glyphicon glyphicon-remove pm_remove"></div><div class="pm_name">'+e+"</div></div>",s+='<div class="pm_body"><div class="pm_body_mssgs">',$.each(i,function(e,t){t.author_id==module.user_id?s+='<div class="pm_mssg_cont"> <div class="pm_message pull-right" style="background-color:#eee;margin-left:30px;margin-right:5px;" title="'+moment.utc(t.created_at).local().format("hh:mma")+'"> '+t.message+" </div> </div>":s+='<div class="pm_mssg_cont"> <div class="pm_message pull-left" style="background-color:#7badfc;margin-right:30px;margin-left:5px;" title="'+moment.utc(t.created_at).local().format("hh:mma")+'"> '+t.message+" </div> </div>"}),s+='</div><div class="pm_body_alerts"> <div class="pm_mssg_alert pm_unseen" style="display:none;">Not seen</div> <div class="pm_mssg_alert pm_typing" style="display:none;">'+e+" is typing...</div> </div></div>",s+='<textarea rows=1 class="pm_text"></textarea>',s+="</div>",$(".pm_bar").prepend(s),$(".pm_cont").resizable({handles:"nw",ghost:!1,maxHeight:450,maxWidth:400,minHeight:330,minWidth:240,resize:function(e,t){var n=t.size.height,r=t.size.width-10;$(this).css("left","0"),$(this).css("top","0"),$(this).find(".pm_header").width(r),$(this).find(".pm_body").height(n-64),$(this).find(".pm_body").width($(this).find(".pm_header").width()+6),$(this).find(".pm_text").width($(this).find(".pm_header").width()-2)}});var o=$("#pm_"+t+"_"+n);if(!parseInt(o.attr("data-stop-scroll"))){var u=o.find(".pm_body");u.off("scroll",pm_scroll_mod),u.scrollTop(u[0].scrollHeight),window.setTimeout(function(){u.on("scroll",pm_scroll_mod)},100)}},error:function(){}}))}),$(".pm_cont").resizable({handles:"nw",ghost:!1,maxHeight:450,maxWidth:400,minHeight:330,minWidth:240,resize:function(e,t){var n=t.size.height,r=t.size.width-10;$(this).css("left","0"),$(this).css("top","0"),$(this).find(".pm_header").width(r),$(this).find(".pm_body").height(n-64),$(this).find(".pm_body").width($(this).find(".pm_header").width()+6),$(this).find(".pm_text").width($(this).find(".pm_header").width()-2)}}),$("body").on("click",".pm_header",function(){var e=$(this).parent().attr("id").split("_");$(this).parent().find(".pm_body").css("display")=="none"?(module.socket.emit("maximize_pm",{friend_id:e[1],pm_id:e[2]}),$(this).parent().resizable("enable"),$(this).parent().find(".pm_body").css("display",""),$(this).parent().find(".pm_text").css("display",""),$(this).parent().find(".pm_body").css("visibility","hidden"),$(".pm_body").mCustomScrollbar("scrollTo","bottom",{scrollInertia:0}),window.setTimeout(function(){$(".pm_body").css("visibility","")},50)):(module.socket.emit("minimize_pm",{friend_id:e[1],pm_id:e[2]}),$(this).parent().css("height")!=""&&($(this).parent().attr("data-expanded-height",$(this).parent().css("height")),$(this).parent().css("height","")),$(this).parent().resizable("disable"),$(this).parent().find(".pm_body").css("display","none"),$(this).parent().find(".pm_text").css("display","none"))});var e=$("#reply_form").clone();$("#request_friend").click(function(){module.socket.emit("request_friend",{user_id:$(this).attr("data-user-id"),user:$(this).attr("data-user-name"),sender_id:module.user_id,sender:module.user_tracker}),$(this).removeClass("btn-primary"),$(this).addClass("btn-success"),$(this).html('<div class="glyphicon glyphicon-check" id="request_glyph"></div> Request Sent'),$(this).off("click")}),$("a#advanced_create").click(function(e){return $("#advanced_modal").modal(),!1}),$(".reply_link").on("click",function(){return $("#message_"+$(this).attr("data-mssg-id")).find("#reply_form_"+$(this).attr("data-mssg-id")).length?($("#message_"+$(this).attr("data-mssg-id")).find("#reply_form_"+$(this).attr("data-mssg-id")).toggle(),$(this).children().text()=="Reply"?$(this).children().text("Cancel"):$(this).children().text("Reply")):($(this).html("<strong>Cancel</strong>"),$("#message_"+$(this).attr("data-mssg-id")).append(e),$("#message_"+$(this).attr("data-mssg-id")).find("#reply_form").attr("id","reply_form_"+$(this).attr("data-mssg-id")),$("#reply_form_"+$(this).attr("data-mssg-id")).children("#reply_to").val($(this).attr("data-mssg-id")),e=$("#reply_form").clone()),!1}),$("#mssg_requests").blur(function(){$(this).popover("hide")}),$("#global_requests").blur(function(){$(this).popover("hide")}),$("#friend_requests").blur(function(){$(this).popover("hide")})}),module.socket.on("receive_pm",function(e){var t=$("#pm_"+e.friend_id+"_"+e.pm_id);if(e.state==0){var n=$("#friend_"+e.friend_id+"_status").attr("class").replace("friend_status","");$.ajax({type:"GET",data:{pm_id:e.pm_id},url:"//mutualcog.com/chat/pm-log",success:function(r){var i='<div class="pm_cont" id="pm_'+e.friend_id+"_"+e.pm_id+'" data-stop-scroll="0">';i+='<div class="pm_header"><div class="'+n+' pm_status"></div><div class="glyphicon glyphicon-remove pm_remove"></div><div class="pm_name">'+e.friend_name+"</div></div>",i+='<div class="pm_body"><div class="pm_body_mssgs">',$.each(r,function(e,t){t.author_id==module.user_id?i+='<div class="pm_mssg_cont"> <div class="pm_message pull-right" style="background-color:#eee;margin-left:30px;margin-right:5px;" title="'+moment.utc(t.created_at).local().format("hh:mma")+'"> '+t.message+" </div> </div>":i+='<div class="pm_mssg_cont"> <div class="pm_message pull-left" style="background-color:#7badfc;margin-right:30px;margin-left:5px;" title="'+moment.utc(t.created_at).local().format("hh:mma")+'"> '+t.message+" </div> </div>"}),i+='</div><div class="pm_body_alerts"> <div class="pm_mssg_alert pm_unseen" style="display:none;">Not seen</div> <div class="pm_mssg_alert pm_typing" style="display:none;">'+e.friend_name+" is typing...</div> </div></div>",i+='<textarea rows=1 class="pm_text"></textarea>',i+="</div>",$(".pm_bar").prepend(i);var s='<div class="pm_mssg_cont">';s+='<div class="pm_message pull-left" style="background-color:#7badfc;margin-right:30px;margin-left:5px;" title="'+moment.utc(e.time).local().format("hh:mma")+'">'+e.message+"</div>",s+="</div>",t=$("#pm_"+e.friend_id+"_"+e.pm_id),t.find(".pm_body_mssgs").append(s);if(!parseInt(t.attr("data-stop-scroll"))){var o=t.find(".pm_body");o.off("scroll",pm_scroll_mod),o.scrollTop(o[0].scrollHeight),window.setTimeout(function(){o.on("scroll",pm_scroll_mod)},100)}},error:function(){}})}else if(e.state==2){t.resizable("enable"),t.parent().find(".pm_body").css("display",""),t.parent().find(".pm_text").css("display","");var r='<div class="pm_mssg_cont">';r+='<div class="pm_message pull-left" style="background-color:#7badfc;margin-right:30px;margin-left:5px;" title="'+moment.utc(e.time).local().format("hh:mma")+'">'+e.message+"</div>",r+="</div>",t.find(".pm_body_mssgs").append(r)}else{var r='<div class="pm_mssg_cont">';r+='<div class="pm_message pull-left" style="background-color:#7badfc;margin-right:30px;margin-left:5px;" title="'+moment.utc(e.time).local().format("hh:mma")+'">'+e.message+"</div>",r+="</div>",t.find(".pm_body_mssgs").append(r)}if(!parseInt(t.attr("data-stop-scroll"))){var i=t.find(".pm_body");i.off("scroll",pm_scroll_mod),i.scrollTop(i[0].scrollHeight),window.setTimeout(function(){i.on("scroll",pm_scroll_mod)},100)}}),module.socket.on("chat_seen",function(e){var t=$("#pm_"+e.friend_id+"_"+e.pm_id);t.find(".pm_unseen").hide()}),module.socket.on("is_typing",function(e){var t=$("#pm_"+e.friend_id+"_"+e.pm_id);t.find(".pm_typing").show()}),module.socket.on("not_typing",function(e){var t=$("#pm_"+e.friend_id+"_"+e.pm_id);t.find(".pm_typing").hide()}),module.socket.on("displayFriendRequests",function(e){var t=$("#friend_requests_count"),n="";t.text().length>0?t.text(parseInt(t.text())+1):($("#friend_request_glyph").addClass("pull-left"),t.text("1")),$("#friend_requests").attr("data-content").indexOf("No friend requests")>=0?$("#friend_requests").attr("data-content","<div class='request_cont'> <div class='request_text'> <a class='chat_link' href='//mutualcog.com/p/"+e.sender+"'>"+e.sender+"</a> has requested your friendship </div> <div class='request_text'> <a class='chat_link' href='//mutualcog.com/profile/accept/"+e.id+"'>Accept</a> / <a class='chat_link' href='//mutualcog.com/profile/decline/"+e.id+"'>Decline</a> </div> </div>"):$("#friend_requests").attr("data-content",$("#friend_requests").attr("data-content").prepend("<div class='request_cont'> <div class='request_text'> <a class='chat_link' href='//mutualcog.com/p/"+e.sender+"'>"+e.sender+"</a> has requested your friendship </div> <div class='request_text'> <a class='chat_link' href='//mutualcog.com/profile/accept/"+e.id+"'>Accept</a> / <a class='chat_link' href='//mutualcog.com/profile/decline/"+e.id+"'>Decline</a> </div> </div>"))}),$("#username").blur(function(){var e=$("#username").val(),t=$("#pass").val();e.length>0&&validateUser(e),e.length>0&&t.length>0&&pass2==""&&validateLogin(e,t)}),$("#pass").blur(function(){var e=$("#username").val(),t=$("#pass").val(),n=$("#pass2").val();e.length>0&&t.length>0&&n==""&&validateLogin(e,t)}),$("#pass2").blur(function(){var e=$("#username").val(),t=$("#pass").val(),n=$("#pass2").val();t.length>0&&n.length>0&&validatePasswords(t,n),e.length>0&&validateUser(e)}),$("#login_form").submit(function(){var e=1,t=$("#username").val(),n=$("#pass").val(),r=$("#pass2").val();return module.user_validated||(t.length>0&&validateUser(t),module.user_validated||(e=0)),module.pass1_validated||(r==""?(t.length>0&&n.length>0&&validateLogin(t,n),module.pass1_validated||(e=0)):e=0),r!=""&&!module.pass2_validated&&(n.length>0&&r.length>0&&validatePasswords(n,r),module.pass2_validated||(e=0)),e?!0:(console.log(module.user_validated),console.log(module.pass1_validated),!1)}),$("#home_form").submit(function(){if(cookiesEnabled()){var e=1,t=$("#Title").val(),n=$("#Tags").val();$(".form_error").hide(),$(".form-group").attr("class","form-group");if(t.length<3||t.length>180)$("#Title").attr("data-original-title","Title must be longer than 2 characters but less than 180"),$("#Title").tooltip("show"),$("#title_group").attr("class","form-group has-error"),e=0;return n.split(" ")[0]==""||n.split(" ").length>5?($("#tags_group").attr("class","form-group has-error"),$("#Tags").attr("data-original-title","Must have at least 1 tag but less than 6"),$("#Tags").tooltip({placement:"left",trigger:"focus"}),$("#Tags").tooltip("show"),e=0):(n=n.split(" "),$.each(n,function(t,n){n=n.substr(1);if((n.length<3||n.length>19)&&n.length!=0)return $("#tags_group").attr("class","form-group has-error"),$("#Tags").attr("data-original-title","Tags must be longer than 2 characters but less than 20"),$("#Tags").tooltip({placement:"left",trigger:"focus"}),$("#Tags").tooltip("show"),e=0,!1})),e?($("#home_form").append('<input type="hidden" name="js_key" value="js_enabled" id="js_key">'),!0):!1}return $("#Title").attr("data-original-title","You must enable cookies to post chats"),$("#Title").tooltip("show"),!1}),$("#home_form_v2").submit(function(){if(cookiesEnabled()){var e=1,t=$("#Title_v2").val(),n=$("#Tags_v2").val();$(".form_error").hide(),$(".form-group").attr("class","form-group");if(t.length<3||t.length>180)$("#Title_v2").attr("data-original-title","Title must be longer than 2 characters but less than 180"),$("#Title_v2").tooltip("show"),$("#title_group_v2").attr("class","form-group has-error"),e=0;return n.split(" ")[0]==""||n.split(" ").length>5?($("#tags_group_v2").attr("class","form-group has-error"),$("#Tags_v2").attr("data-original-title","Must have at least 1 tag but less than 6"),$("#Tags_v2").tooltip({placement:"bottom",trigger:"focus"}),$("#Tags_v2").tooltip("show"),e=0):(n=n.split(" "),$.each(n,function(t,n){n=n.substr(1);if((n.length<3||n.length>19)&&n.length!=0)return $("#tags_group_v2").attr("class","form-group has-error"),$("#Tags_v2").attr("data-original-title","Tags must be longer than 2 characters but less than 20"),$("#Tags_v2").tooltip({placement:"bottom",trigger:"focus"}),$("#Tags_v2").tooltip("show"),e=0,!1})),e?($("#home_form_v2").append('<input type="hidden" name="js_key" value="js_enabled" id="js_key">'),!0):!1}return $("#Title").attr("data-original-title","You must enable cookies to post chats"),$("#Title").tooltip("show"),!1}),$(".big_upvote").click(function(e){e.stopPropagation();var t=$(this).attr("id"),n=$(this).attr("id").replace("upvote_",""),r="//mutualcog.com/chat/upvote";$.ajax({type:"POST",data:{id:n},url:r,success:function(e){e.status==1||e.status==3?($("#votes_"+n).text(e.upvotes),$("#upvote_"+n).css("color","#57bf4b"),$("#downvote_"+n).css("color","")):e.status==2?($("#votes_"+n).text(e.upvotes),$("#upvote_"+n).css("color",""),$("#downvote_"+n).css("color","")):$("#"+t).tooltip("show")},error:function(){}})}),$(".big_downvote").click(function(e){e.stopPropagation();var t=$(this).attr("id"),n=$(this).attr("id").replace("downvote_",""),r="//mutualcog.com/chat/downvote";$.ajax({type:"POST",data:{id:n},url:r,success:function(e){e.status==1||e.status==3?($("#votes_"+n).text(e.upvotes),$("#downvote_"+n).css("color","red"),$("#upvote_"+n).css("color","")):e.status==2?($("#votes_"+n).text(e.upvotes),$("#upvote_"+n).css("color",""),$("#downvote_"+n).css("color","")):$("#"+t).tooltip("show")},error:function(){}})}),upvoteMssg=function(e){e.stopPropagation();var t=$(this).attr("id").replace("mssg_upvote_",""),n="//mutualcog.com/chat/message-upvote";$.ajax({type:"POST",data:{id:t},url:n,success:function(e){e.status==1||e.status==3?($("#mssg_upvote_"+t).css("color","#57bf4b"),$("#mssg_downvote_"+t).css("color",""),$("#mssg_votes_"+t).text(e.upvotes)):e.status==2?($("#mssg_upvote_"+t).css("color",""),$("#mssg_downvote_"+t).css("color",""),$("#mssg_votes_"+t).text(e.upvotes)):$("#mssg_upvote_"+t).tooltip("show")},error:function(){}})},downvoteMssg=function(e){e.stopPropagation();var t=$(this).attr("id").replace("mssg_downvote_",""),n="//mutualcog.com/chat/message-downvote";$.ajax({type:"POST",data:{id:t},url:n,success:function(e){e.status==1||e.status==3?($("#mssg_downvote_"+t).css("color","red"),$("#mssg_upvote_"+t).css("color",""),$("#mssg_votes_"+t).text(e.upvotes)):e.status==2?($("#mssg_upvote_"+t).css("color",""),$("#mssg_downvote_"+t).css("color",""),$("#mssg_votes_"+t).text(e.upvotes)):$("#mssg_downvote_"+t).tooltip("show")},error:function(){}})},$("#tag_dropdown").on("click",function(e){e.stopPropagation()}),$("#search_input").on("focus",function(e){e.stopPropagation(),$("#search_input").val()==""&&$("#tag_dropdown").html(""),$(this).dropdown(),$("#tag_dropdown").show()}),$(window).on("click",function(e){$("#tag_dropdown").hide()});var selected_term=-1;$("#search_input").on("keydown",function(e){if(e.keyCode==13)return selected_term!=-1&&location.assign($("li#search_"+selected_term).children("a").attr("href")),!1;if(e.keyCode==38)return selected_term!=0&&(selected_term--,$(".tag_results").css("background-color",""),$("li#search_"+selected_term).css("background-color","#ddd")),!1;if(e.keyCode==40)return selected_term!=$("#tag_dropdown").children().length-1&&(selected_term++,$(".tag_results").css("background-color",""),$("li#search_"+selected_term).css("background-color","#ddd")),!1}),$("#search_input").on("keyup",function(e){var t=$(this).val();if(e.keyCode==13)return!1;e.keyCode!=38&&e.keyCode!=40&&(t.length>2?$.ajax({type:"GET",data:{tag:t},url:"//mutualcog.com/tags/similar-tag",success:function(e){var t="";$.each(e,function(e,n){n.type=="tag"?t+='<li id="search_'+e+'" class="tag_results"><a href="//mutualcog.com/t/'+n.name+'">'+n.name+"</a></li>":t+='<li id="search_'+e+'" class="tag_results"><a href="//mutualcog.com/p/'+n.name+'">'+n.name+"</a></li>"}),t?($("#tag_dropdown").show(),$("#tag_dropdown").html()!=t&&($("#tag_dropdown").html(t),selected_term=-1)):($("#tag_dropdown").hide(),selected_term=-1)},error:function(){}}):$("#tag_dropdown").html(""))}),$(".tags_input").on("keydown",function(e){if(e.keyCode==13){if(selected_tag!=-1){var t=$(this).val().split(" ");return t.pop(),t.push("#"+$(".suggested_tags").eq(selected_tag).text()),$(this).val(t.join(" ")+" #"),$(this).focus(),!1}return!1}if(e.keyCode==38){if($(".popover").length!=0)return selected_tag!=0&&(selected_tag-=1,$(".suggested_tags").css("color",""),$(".suggested_tags").eq(selected_tag).css("color","#57bf4b")),!1}else if(e.keyCode==40&&$(".popover").length!=0)return selected_tag!=$(".suggested_tags").length-1&&(selected_tag+=1,$(".suggested_tags").css("color",""),$(".suggested_tags").eq(selected_tag).css("color","#57bf4b")),!1}),$(".tags_input").on("keyup",function(e){if(e.keyCode==32)if($(this).val().length==1)$(this).val("");else{var t=$(this).val().split(" "),n=new Array;$.each(t,function(e,t){t=t.replace("#",""),n.push("#"+t)}),$(this).val(n.join(" ")),$(this).popover("destroy"),selected_tag=-1}else if(e.keyCode!=38&&e.keyCode!=40){var r=$(this).val().split(" ");r=r.pop().replace("#","");if(r.length>2){var i=$(this);$(this).on("blur",function(){$(".popover").length&&$(this).popover("hide")}),$.ajax({type:"GET",data:{tag:r.slice(0,-1)},url:"//mutualcog.com/tags/similar-tag",success:function(e){var t="";$.each(e,function(e,n){t+='<div class="suggested_tags" id="'+n.id+'">'+n.name+"</div>"}),$(".popover").length==0?t&&(i.popover({html:!0}),i.attr("data-content",t),i.popover("show"),$(".suggested_tags").click(function(){var e=$(".tags_input").val().split(" ");e.pop(),e.push("#"+$(this).text()),i.val(e.join(" ")+" #"),i.focus(),i.popover("destroy"),selected_tag=-1}),selected_tag=-1):t?$(".popover-content").html()!=t&&($(".popover-content").html(t),selected_tag=-1,$(".suggested_tags").off("click"),$(".suggested_tags").click(function(){var e=$(".tags_input").val().split(" ");e.pop(),e.push("#"+$(this).text()),i.val(e.join(" ")+" #"),i.focus(),i.popover("destroy"),selected_tag=-1})):(i.popover("destroy"),selected_tag=-1)},error:function(){}})}else $(this).popover("destroy"),selected_tag=-1}});var pm_keys=new Array;$("body").on("cut",".pm_text",function(e){var t=$(this),n=this;window.setTimeout(function(){t.height(0),t.height(n.scrollHeight-10)},0)}),$("body").on("paste",".pm_text",function(e){var t=$(this),n=this;window.setTimeout(function(){t.height(0),t.height(n.scrollHeight-10)},0)}),$("body").on("keydown",".pm_text",function(e){pm_keys.push(e.which);var t=$(this),n=this;window.setTimeout(function(){t.height(0),t.height(n.scrollHeight-10)},0)}),$("body").on("keyup",".pm_text",function(e){module.pm_info=$(this).parent().attr("id").split("_");var t=$(this).parents(".pm_cont");module.user_id.length&&(module.recent>120&&module.socket.emit("seen_chats"),module.recent=0);if(e.which==13)if(pm_keys.indexOf(16)==-1){pm_keys.splice(pm_keys.indexOf(e.which),1),module.typ_cnt>0&&module.socket.emit("not_typing",{pm_id:module.pm_info[2],friend_id:module.pm_info[1],user_id:module.user_id});if($(this).val().trim()!=""){module.socket.emit("send_pm",{message:$(this).val(),pm_id:module.pm_info[2],friend_id:module.pm_info[1],user_id:module.user_id},function(e){var t=$("#pm_"+e.friend_id+"_"+e.pm_id),n=t.find(".tmp_message");n.find(".pm_message").html(e.message),n.attr("class",n.attr("class").replace("tmp_message","")),e.unseen&&t.find(".pm_unseen").show()}),$(this).css("height","");var n='<div class="pm_mssg_cont tmp_message">';n+='<div class="pm_message pull-right" style="background-color:#eee;margin-left:30px;margin-right:5px;" title="'+moment().format("hh:mma")+'">'+$(this).val()+"</div>",n+="</div>",$("#pm_"+module.pm_info[1]+"_"+module.pm_info[2]).find(".pm_body_mssgs").append(n),$(this).val("");if(!parseInt(t.attr("data-stop-scroll"))){var r=t.find(".pm_body");r.off("scroll",pm_scroll_mod),r.scrollTop(r[0].scrollHeight),window.setTimeout(function(){r.on("scroll",pm_scroll_mod)},100)}}module.typ_cnt=0}else module.typ_cnt==0&&module.socket.emit("is_typing",{pm_id:module.pm_info[2],friend_id:module.pm_info[1],user_id:module.user_id}),pm_keys.splice(keys.indexOf(e.which),1),module.typ_cnt=4;else module.typ_cnt==0&&module.socket.emit("is_typing",{pm_id:module.pm_info[2],friend_id:module.pm_info[1],user_id:module.user_id}),pm_keys.splice(pm_keys.indexOf(e.which),1),module.typ_cnt=4;return!0})