{% extends 'home_layout.twig' %}
{% use 'common.twig' %}

{% block header %}
	{{parent()}}
{% endblock %}

{% block tools %}
{% if user.name == chat.admin or serial == chat.admin %}
                        <div class="small_content_box tool_box">
				<div class="content side_content box_r_0">
<div id="user_toolbox">
	{% if chat.live %}
		<a href="{{site}}/chat/pause-chat/{{chat.id}}" class="glyphicon glyphicon-pause pause mod_power" id="pause_chat" data-toggle="tooltip" data-container="body" data-placement="top" data-original-title="Pause chat"></a>
	{% else %}
		<a href="{{site}}/chat/play-chat/{{chat.id}}" class="glyphicon glyphicon-play play mod_power" id="pause_chat" data-toggle="tooltip" data-container="body" data-placement="top" data-original-title="Play chat"></a>
	{% endif %}
	<!--<span class="glyphicon glyphicon-tower mod_power" id="mod_user" data-toggle="tooltip" data-container="body" data-placement="top" data-original-title="Grant holy moderation powers"></span>
	<span class="glyphicon glyphicon-warning-sign mod_power" id="warn_user" data-toggle="tooltip" data-container="body" data-placement="top" data-original-title="Warn user"></span>
	<span class="glyphicon glyphicon-remove mod_power" id="kick_user" data-toggle="tooltip" data-container="body" data-placement="top" data-original-title="Kick user"></span>-->
</div>
				</div>
                        </div>
{% endif %}
{% endblock %}

{% block welcome %}
	{{parent()}}
{% endblock %}

{% block side_1 %}
	<div class="small_content_box">
		<div class="content side_content" id="subscribe">
<div style="margin-top:5px;">
	<btn class="btn btn-primary" style="width:100%;" data-toggle="modal" data-target="#chat_modal">Create Chat</btn>
</div>
{% if not curr_tag_id and user %}
	<div style="margin-top:10px;">
		<btn class="btn btn-primary" style="width:100%;" data-toggle="modal" data-target="#tag_create_modal">Create Community</btn>
	</div>
{% endif %}
		</div>
	</div>
{% endblock %}

{% block side_2 %}
{% if not chat.live %}
                        <div class="small_content_box">
				<div class="content_right">
				<div class="content_left">
					<div class="content side_content" id="create_new_mssg">
<form method="post" action="{{site}}/chat/message/{{chat.id}}">
	<legend>Submit a new Message</legend>
	<textarea rows="4" name="mssg_content" maxlength="{{max_static_length}}"></textarea>
	<button type="submit" class="btn btn-primary" style="width:100%;">Send Message</button>
</form>
					</div>
                                </div>
				</div>
                        </div>
{% endif %}
{% endblock %}

{% block content %}
<div class="chat_content">
<div class="chat_title_vote_box">
	{% if chat.id in upvoted %}
		<span class="glyphicon glyphicon-chevron-up big_upvote" id="upvote_{{chat.id}}" style="color:#57bf4b" data-toggle="tooltip" data-original-title="You must be logged in to vote on posts" data-container="body" data-placement="top"></span>
		<div class="upvote_count" id="votes_{{chat.id}}">{{chat.upvotes - chat.downvotes}}</div>
		<span class="glyphicon glyphicon-chevron-down big_downvote" id="downvote_{{chat.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on posts" data-container="body" data-placement="bottom"></span>
	{% elseif chat.id in downvoted %}
		<span class="glyphicon glyphicon-chevron-up big_upvote" id="upvote_{{chat.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on posts" data-container="body" data-placement="top"></span>
		<div class="upvote_count" id="votes_{{chat.id}}">{{chat.upvotes - chat.downvotes}}</div>
		<span class="glyphicon glyphicon-chevron-down big_downvote" id="downvote_{{chat.id}}" style="color:red;" data-toggle="tooltip" data-original-title="You must be logged in to vote on posts" data-container="body" data-placement="bottom"></span>
	{% else %}
		<span class="glyphicon glyphicon-chevron-up big_upvote" id="upvote_{{chat.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on posts" data-container="body" data-placement="top"></span>
		<div class="upvote_count" id="votes_{{chat.id}}">{{chat.upvotes - chat.downvotes}}</div>
		<span class="glyphicon glyphicon-chevron-down big_downvote" id="downvote_{{chat.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on posts" data-container="body" data-placement="bottom"></span>
	{% endif %}
</div>
{% if chat.image %}
	<a class="pull-left link_thumbnail" href="{{chat.link}}">
		<img src="{{chat.image}}" alt="Image Error" width="80" height="80">
	</a>
{% endif %}
{% if chat.live %}
	<div class="pull-right glyphicon glyphicon-play brighter_green_color chat_status_indicator" data-toggle="tooltip" data-original-title="Live Chat" data-container="body" data-placement="top"></div>
{% else %}
	<div class="pull-right glyphicon glyphicon-pause darker_yellow_color chat_status_indicator" data-toggle="tooltip" data-original-title="Static Chat" data-container="body" data-placement="top"></div>
{% endif %}
<div class="static_chat_title">
	{% if chat.seen %}
		{% if chat.link %}
			<a href="{{chat.link}}" style="color:purple;">{{chat.title}}</a> <span class="site_name">from {{chat.site_name}}</span>
		{% else %}
			<a href="{{site}}/chat/{% if chat.live %}live{% else %}static{% endif %}/{{chat.id}}" style="color:purple;">{{chat.title}}</a>
		{% endif %}
	{% else %}
		{% if chat.link %}
			<a href="{{chat.link}}" style="color:#032f75;">{{chat.title}}</a> <span class="site_name">from {{chat.site_name}}</span>
		{% else %}
			<a href="{{site}}/chat/{% if chat.live %}live{% else %}static{% endif %}/{{chat.id}}" style="color:#032f75;">{{chat.title}}</a>
		{% endif %}
	{% endif %}
	{% if chat.admin % 16777259 == 0 %}
		<div class="chat_info">Created by <a href="{{site}}/u/{{chat.admin}}" style="color:gray;"><strong>{{chat.admin}}</strong></a>, 
	{% else %}
		<div class="chat_info">Created by <strong>{{chat.admin}}</strong>, 
	{% endif %}
		{% set time_passed = server_time|date('U') - chat.created_at|date('U') %}
		<span class="chat_time" id="{{chat.created_at}}">
			{% if time_passed < 45 %}
				seconds ago
			{% elseif time_passed < 2700 %}
				{% if time_passed < 90 %}
					a minute ago
				{% else %}
					{{(time_passed/60)|round}} minutes ago
				{% endif %}
			{% elseif time_passed < 79200%}
				{% if time_passed < 5400 %}
					an hour ago
				{% else %}
					{{(time_passed/3600)|round}} hours ago
				{% endif %}
			{% elseif time_passed < 2160000 %}
				{% if time_passed < 129600 %}
					a day ago
				{% else %}
					{{(time_passed/86400)|round}} days ago
				{% endif %}
			{% elseif time_passed < 29808000 %}
				{% if time_passed < 3888000 %}
					a month ago
				{% else %}
					{{(time_passed/2592000)|round}} months ago
				{% endif %}
			{% else %}
				{% if time_passed < 47260800 %}
					a year ago
				{% else %}
					{{(time_passed/31536000)|round}} years ago
				{% endif %}
			{% endif %}
		</span>
		with Tags:
		{% for tag in chat.tags %}
			<span class="chat_tags"><a href="{{site}}/t/{{tag.name}}" style="color:#075de9;">#{{tag.name}}</a> </span>
		{% endfor %}
		and <a href="{{site}}/chat/{% if chat.live %}live{% else %}static{% endif %}/{{chat.id}}" style="color:gray;"><strong>{{chat.messages | length }} comments</strong></a>
	</div>
	<div class="chat_details">
		{{chat.details | raw}}
	</div>
</div>
{% if not chat.live %}
<form method="post" class="visible-xs" action="{{site}}/chat/message/{{chat.id}}">
	<textarea rows="4" name="mssg_content" maxlength="{{max_static_length}}"></textarea>
	<button type="submit" class="btn btn-sm btn-primary">Send Message</button>
</form>
{% endif %}
</div>
{% endblock %}

{% block chat_content %}
<div id="reply_form_box" style="display:none;">
<form method="post" id="reply_form" class="reply_forms" action="{{site}}/chat/message/{{chat.id}}">
	<input type="hidden" name="reply_to" id="reply_to">
	<textarea rows="3" name="mssg_content" maxlength="{{max_static_length}}"></textarea>
	<button type="submit" class="btn btn-sm btn-primary">Send Message</button>
</form>
</div>
<div class="big_content_box" style="margin-top:15px;margin-bottom:15px;">
	<div class="content_right">
	<div class="content_left">
		<div class="chat_content">
		{% set load_more = 0 %}
		{% for message in messages %}
			{% if recursive or message.level == init_level %}
				{% set load_more = 0 %}
			{% endif %}
			{% if loop.first %}
				{% set init_level = message.level %}
			{% endif %}
			{% if message.h_level <= init_level + 11 - message.level %}
			{% if not loop.first and prev_level >= message.level %}
				{% set load_more = 0 %}
				{% for i in message.level..prev_level %}
					</div>
					</div>
				{% endfor %}
			{% endif %}
			{% if message.level == init_level %}
			<div class="response_to_{{message.responseto}} mssg_cont level_{{message.level}} parent_{{message.parent}}" id="mssg_cont_{{message.id}}">
			{% else %}
			<div class="response_to_{{message.responseto}} mssg_cont level_{{message.level}} parent_{{message.parent}} {% if message.level > init_level + 3 %}hidden-xs {% endif %}{% if message.level > init_level + 5 %}hidden-sm {% endif %}{% if message.level > init_level + 8 %}hidden-md {% endif %}{% if message.level > init_level + 12 %}hidden-lg {% endif %}pad_l_20" id="mssg_cont_{{message.id}}">
			{% endif %}
			<div class="mssg_cont_inner">
				<div class="chat_mssg" id="message_{{message.id}}">
					<div class="row" style="margin:0;">
						<div class="mssg_body_cont">
							<div class="chat_vote_box">
								{% if message.id in mssg_upvoted %}
									<span class="glyphicon glyphicon-chevron-up mssg_upvote" id="mssg_upvote_{{message.id}}" style="color:#57bf4b" data-toggle="tooltip" data-original-title="You must be logged in to vote on messages" data-container="body" data-placement="top"></span>
									<div class="upvote_count" id="mssg_votes_{{message.id}}">{{message.upvotes - message.downvotes}}</div>
									<span class="glyphicon glyphicon-chevron-down mssg_downvote" id="mssg_downvote_{{message.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on messages" data-container="body" data-placement="bottom"></span>
								{% elseif message.id in mssg_downvoted %}
									<span class="glyphicon glyphicon-chevron-up mssg_upvote" id="mssg_upvote_{{message.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on messages" data-container="body" data-placement="top"></span>
									<div class="upvote_count" id="mssg_votes_{{message.id}}">{{message.upvotes - message.downvotes}}</div>
									<span class="glyphicon glyphicon-chevron-down mssg_downvote" id="mssg_downvote_{{message.id}}" style="color:red;" data-toggle="tooltip" data-original-title="You must be logged in to vote on messages" data-container="body" data-placement="bottom"></span>
								{% else %}
									<span class="glyphicon glyphicon-chevron-up mssg_upvote" id="mssg_upvote_{{message.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on messages" data-container="body" data-placement="top"></span>
									<div class="upvote_count" id="mssg_votes_{{message.id}}">{{message.upvotes - message.downvotes}}</div>
									<span class="glyphicon glyphicon-chevron-down mssg_downvote" id="mssg_downvote_{{message.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on messages" data-container="body" data-placement="bottom"></span>
								{% endif %}
							</div>
							<div class="mssg_body author_{{message.author}}">
								<div id="toggle_{{message.id}}" class="toggle_responses">
									<span class="caret caret_tooltip" id="caret_{{message.id}}" data-toggle="tooltip" data-original-title="Hide Responses" data-container="body" data-placement="top"></span>
								</div>
								{% if 'This message has been deleted' in message.message == 0 and (serial == message.author or user.name == message.author) %}
									<span id="message.id" class="glyphicon glyphicon-remove mssg_icon" data-toggle="tooltip" title="Delete post" data-container="body" data-placement="top"></span>	
								{% endif %}  
								{% if message.author == chat.admin %}
									<span class="glyphicon glyphicon-star"></span>	
								{% endif %}
								{% if message.author in mods %}
									<span class="glyphicon glyphicon-tower"></span>	
								{% endif %}
								<strong class="mssg_op" data-author="{{message.author}}" style="color:{{color_arr[message.serial % 7]}}"> {{message.author}} (<span class="response_count" id="{{message.id}}">{{message.responses}}</span>)</strong> : {{message.message | raw}}
								<div class="time_box">
									{% if not chat.live %}<div class="reply"><a href="#" class="reply_link" data-mssg-id="{{message.id}}"><strong>Reply</strong></a></div>{% endif %}
									{% set time_passed = server_time|date('U') - message.created_at|date('U') %}
									<div class="time" id="{{message.created_at}}" title="{{message.created_at}} UTC">
										{% if time_passed < 45 %}
											seconds ago
										{% elseif time_passed < 2700 %}
											{% if time_passed < 90 %}
												a minute ago
											{% else %}
												{{(time_passed/60)|round}} minutes ago
											{% endif %}
										{% elseif time_passed < 79200%}
											{% if time_passed < 5400 %}
												an hour ago
											{% else %}
												{{(time_passed/3600)|round}} hours ago
											{% endif %}
										{% elseif time_passed < 2160000 %}
											{% if time_passed < 129600 %}
												a day ago
											{% else %}
												{{(time_passed/86400)|round}} days ago
											{% endif %}
										{% elseif time_passed < 29808000 %}
											{% if time_passed < 3888000 %}
												a month ago
											{% else %}
												{{(time_passed/2592000)|round}} months ago
											{% endif %}
										{% else %}
											{% if time_passed < 47260800 %}
												a year ago
											{% else %}
												{{(time_passed/31536000)|round}} years ago
											{% endif %}
										{% endif %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
		{% if recursive %}
		{% for response in message.descendants %}
			{% if response.h_level <= init_level + 11 - response.level %}
			{% if not loop.first and prev_level >= response.level %}
				{% set load_more = 0 %}
				{% for i in response.level..prev_level %}
					</div>
					</div>
				{% endfor %}
			{% endif %}
			<div class="response_to_{{response.responseto}} mssg_cont level_{{response.level}} parent_{{response.parent}} {% if response.level > 3 %}hidden-xs {% endif %}{% if response.level > 5 %}hidden-sm {% endif %}{% if response.level > 8 %}hidden-md {% endif %}{% if response.level > 12 %}hidden-lg {% endif %}pad_l_20" id="mssg_cont_{{response.id}}">
			<div class="mssg_cont_inner">
				<div class="chat_mssg" id="response_{{response.id}}">
					<div class="row" style="margin:0;">
						<div class="mssg_body_cont">
							<div class="chat_vote_box">
								{% if response.id in mssg_upvoted %}
									<span class="glyphicon glyphicon-chevron-up mssg_upvote" id="mssg_upvote_{{response.id}}" style="color:#57bf4b" data-toggle="tooltip" data-original-title="You must be logged in to vote on responses" data-container="body" data-placement="top"></span>
									<div class="upvote_count" id="mssg_votes_{{response.id}}">{{response.upvotes - response.downvotes}}</div>
									<span class="glyphicon glyphicon-chevron-down mssg_downvote" id="mssg_downvote_{{response.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on responses" data-container="body" data-placement="bottom"></span>
								{% elseif response.id in mssg_downvoted %}
									<span class="glyphicon glyphicon-chevron-up mssg_upvote" id="mssg_upvote_{{response.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on responses" data-container="body" data-placement="top"></span>
									<div class="upvote_count" id="mssg_votes_{{response.id}}">{{response.upvotes - response.downvotes}}</div>
									<span class="glyphicon glyphicon-chevron-down mssg_downvote" id="mssg_downvote_{{response.id}}" style="color:red;" data-toggle="tooltip" data-original-title="You must be logged in to vote on responses" data-container="body" data-placement="bottom"></span>
								{% else %}
									<span class="glyphicon glyphicon-chevron-up mssg_upvote" id="mssg_upvote_{{response.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on responses" data-container="body" data-placement="top"></span>
									<div class="upvote_count" id="mssg_votes_{{response.id}}">{{response.upvotes - response.downvotes}}</div>
									<span class="glyphicon glyphicon-chevron-down mssg_downvote" id="mssg_downvote_{{response.id}}" data-toggle="tooltip" data-original-title="You must be logged in to vote on responses" data-container="body" data-placement="bottom"></span>
								{% endif %}
							</div>
							<div class="mssg_body author_{{response.author}}">
								<div id="toggle_{{response.id}}" class="toggle_responses">
									<span class="caret caret_tooltip" id="caret_{{response.id}}" data-toggle="tooltip" data-original-title="Hide Responses" data-container="body" data-placement="top"></span>
								</div>
								{% if 'This response has been deleted' in response.response == 0 and (serial == response.author or user.name == response.author) %}
									<span id="response.id" class="glyphicon glyphicon-remove mssg_icon" data-toggle="tooltip" title="Delete post" data-container="body" data-placement="top"></span>	
								{% endif %}  
								{% if response.author == chat.admin %}
									<span class="glyphicon glyphicon-star"></span>	
								{% endif %}
								{% if response.author in mods %}
									<span class="glyphicon glyphicon-tower"></span>	
								{% endif %}
								<strong class="mssg_op" data-author="{{response.author}}" style="color:{{color_arr[response.serial % 7]}}"> {{response.author}} (<span class="response_count" id="{{response.id}}">{{response.responses}}</span>)</strong> : {{response.message | raw}}
								<div class="time_box">
									{% if not chat.live %}<div class="reply"><a href="#" class="reply_link" data-mssg-id="{{response.id}}"><strong>Reply</strong></a></div>{% endif %}
									{% set time_passed = server_time|date('U') - response.created_at|date('U') %}
									<div class="time" id="{{response.created_at}}" title="{{response.created_at}} UTC">
										{% if time_passed < 45 %}
											seconds ago
										{% elseif time_passed < 2700 %}
											{% if time_passed < 90 %}
												a minute ago
											{% else %}
												{{(time_passed/60)|round}} minutes ago
											{% endif %}
										{% elseif time_passed < 79200%}
											{% if time_passed < 5400 %}
												an hour ago
											{% else %}
												{{(time_passed/3600)|round}} hours ago
											{% endif %}
										{% elseif time_passed < 2160000 %}
											{% if time_passed < 129600 %}
												a day ago
											{% else %}
												{{(time_passed/86400)|round}} days ago
											{% endif %}
										{% elseif time_passed < 29808000 %}
											{% if time_passed < 3888000 %}
												a month ago
											{% else %}
												{{(time_passed/2592000)|round}} months ago
											{% endif %}
										{% else %}
											{% if time_passed < 47260800 %}
												a year ago
											{% else %}
												{{(time_passed/31536000)|round}} years ago
											{% endif %}
										{% endif %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			{% set prev_level = response.level %}
			{% else %}
				<!--{% if load_more == 0 %}
					<div class="response_to_{{response.responseto}} mssg_cont level_{{response.level}} parent_{{response.parent}} {% if response.level > init_level + 3 %}hidden-xs {% endif %}{% if response.level > init_level + 5 %}hidden-sm {% endif %}{% if response.level > init_level + 8 %}hidden-md {% endif %}{% if response.level > init_level + 12 %}hidden-lg {% endif %}pad_l_20" id="mssg_cont_{{response.id}}">
						Load more
					</div>
				{% endif %}-->
				{% set load_more = load_more + 1 %}
			{% endif %}
			{% if loop.last %}
				{% if response.level > 1 %}
					{% for i in 1..response.level %}
						</div>
						</div>
					{% endfor %}
				{% else %}
					</div>
					</div>
				{% endif %}
			{% endif %}
		{% else %}
		{% endfor %}
		{% endif %}
			{% set prev_level = message.level %}
			{% else %}
				<!--{% if load_more == 0 %}
					<div class="response_to_{{message.responseto}} mssg_cont level_{{message.level}} parent_{{message.parent}} {% if message.level > init_level + 3 %}hidden-xs {% endif %}{% if message.level > init_level + 5 %}hidden-sm {% endif %}{% if message.level > init_level + 8 %}hidden-md {% endif %}{% if message.level > init_level + 12 %}hidden-lg {% endif %}pad_l_20" id="mssg_cont_{{message.id}}">
						Load more
					</div>
				{% endif %}-->
				{% set load_more = load_more + 1 %}
			{% endif %}
			{% if loop.last %}
				{% if message.level > init_level %}
					{% for i in init_level..message.level %}
						</div>
						</div>
					{% endfor %}
				{% else %}
					</div>
					</div>
				{% endif %}
			{% endif %}
		{% else %}
		{% endfor %}
		<div class="page_links">
			{{messages.links|raw}}
		</div>
		<div class="policy">
			<span style="margin-left:-104px;"><a href="{{site}}/privacy">Privacy Policy</a></span> |
			<span><a href="{{site}}/terms">Terms of Use</a></span>
		</div>
		</div>
	</div>
	</div>
</div>
{% endblock %}
